---
layout: default
current: compilehealth
class: compilehealth-template
disqus: false
header_extra: project-compilehealth.html
hide_footer: true
---

<!-- < default -->
<!-- The tag above means: insert everything in this file
into the {body} of the default.hbs template -->

<!-- The big featured header, it uses blog cover image as a BG if available -->
<header class="site-header outer">
    <div class="inner">
        {% include site-nav.html %}
    </div>
</header>

<!-- Everything inside the #post tags pulls data from the post -->
<!-- #post -->

{{ content }}

<div id="compile-table"></div>

<script type="text/javascript" src="{{ site.baseurl_fix }}assets/compile-health/compile-health-data.js"></script>

<style>
    span.code {
        font-family: Fira Code, monospace;
    }

    span.cpp-header {
        font-weight: bold;
        color: #569cd6;
    }

    .tabulator-row.tabulator-group {
        min-height: 0 !important;
        background: #ddd;
    }

    .tabulator-row .tabulator-cell {
        padding: 5px !important;
    }

    .tabulator-row {
        min-height: 20px !important;
    }

    .tabulator-row.tabulator-row-odd {
        background: #f6f6f6;
    }

    .unit-suffix {
        color: #888;
    }

    .result-nr {
        color: rgb(33, 57, 77);
    }

    div.tabulator-header-filter {
        position: absolute !important;
        top: 8px;
        left: 140px;
        right: 30px;
        width: auto !important;
    }
</style>

<script>
    $(function () {

        function round1(v) {
            if (Math.round(v * 10) / 10 == 0)
                return "0"
            return (Math.round(v * 10) / 10).toFixed(1)
        }

        function rangeR(d, div, suffix, v0, v1) {
            var prefix = "<span class='result-nr'>";
            suffix = "</span> <span class='unit-suffix'>" + suffix + "</span>";

            var only_first = v1 === undefined
            v0 /= div;
            v1 /= div;
            if (d == 0) {
                v0 = Math.round(v0)
                v1 = Math.round(v1)
            }
            else if (d == 1) {
                v0 = round1(v0)
                v1 = round1(v1)
            }
            if (only_first || v0 == v1)
                return prefix + v0 + suffix;
            return prefix + v0 + " .. " + v1 + suffix;
        }

        function formatTime(v0, v1) {
            return rangeR(0, 1, "ms", v0, v1);
        }
        function formatLoC(v0, v1) {
            return rangeR(1, 1000, "kLoC", v0, v1);
        }
        function formatBin(v0, v1) {
            return rangeR(1, 1024, "kB", v0, v1);
        }

        function computeImpact(e) {
            var t = e.ctime_raw; // in ms
            var i = 0;

            i += 100 * (1 - 200 / (200 + t))

            return i;
        }

        // post-process data a bit
        var data = [];
        var i;
        for (i = 0; i < table_data.length; ++i) {
            var e = table_data[i];
            var t = e.compile_time - e.compile_time_base
            if (t < 0) t = 0;
            e.ctime_raw = Math.round(t * 1000);
            e.impact = computeImpact(e);
            e.object_size_full = e.object_size;
            e.object_size -= e.object_size_base;
            // e.argstr = "<pre>" + e.argstr + "</pre>";

            e.ctime_max = e.ctime_raw
            e.binsize_max = e.object_size
            e.lines_max = e.line_count

            if (i > 0 && data[data.length - 1].file == e.file) {
                data[data.length - 1]._children.push(e);
            }
            else // new file
            {
                c = JSON.parse(JSON.stringify(e));
                e._children = [c];
                data.push(e);
            }
        }
        var proj_idx = 0
        for (i = 0; i < data.length; ++i) {
            var e = data[i];
            if (i > 0 && data[i - 1].project != e.project)
                proj_idx += 1
            e.argstr = "...";
            e.compiler_name = "...";
            var imsum = 0;
            var ctmin = e.ctime_raw
            var ctmax = e.ctime_raw
            var locmin = e.line_count
            var locmax = e.line_count
            var binmin = e.object_size
            var binmax = e.object_size
            var j;
            for (j = 0; j < e._children.length; ++j) {
                var c = e._children[j];
                imsum = c.impact > imsum ? c.impact : imsum;
                if (c.ctime_raw < ctmin) ctmin = c.ctime_raw;
                if (c.ctime_raw > ctmax) ctmax = c.ctime_raw;
                if (c.line_count < locmin) locmin = c.line_count;
                if (c.line_count > locmax) locmax = c.line_count;
                if (c.object_size < binmin) binmin = c.object_size;
                if (c.object_size > binmax) binmax = c.object_size;

                c.name = " <span class='code'>" + c.compiler + " " + c.argstr + "</span>";
                c.ctime = formatTime(c.ctime_raw);
                c.lines = formatLoC(c.line_count);
                c.binsize = formatBin(c.object_size);
            }
            e.name = "<span class='code cpp-header'>" + e.name
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;") + "</span>";
            e.impact = imsum; // / e._children.length;
            e.ctime = formatTime(ctmin, ctmax);
            e.lines = formatLoC(locmin, locmax);
            e.binsize = formatBin(binmin, binmax);
            e.ctime_max = ctmax
            e.lines_max = locmax
            e.binsize_max = binmax
            e.project_idx = proj_idx
        }

        var headerAlignRight = function (cell, formatterParams, onRendered) {
            cell.getElement().style.textAlign = 'right';
            return '' + cell.getValue()
        }

        var make_sorter = function (name) {
            return function (a, b, aRow, bRow, column, dir, sorterParams) {
                var da = aRow.getData();
                var db = bRow.getData();
                if (da.project_idx != db.project_idx)
                    return dir == "asc" ? da.project_idx - db.project_idx : db.project_idx - da.project_idx
                else
                    return da[name] - db[name]
            };
        }
        var make_str_sorter = function (name) {
            return function (a, b, aRow, bRow, column, dir, sorterParams) {
                var da = aRow.getData();
                var db = bRow.getData();
                if (da.project_idx != db.project_idx)
                    return dir == "asc" ? da.project_idx - db.project_idx : db.project_idx - da.project_idx
                else {
                    var sa = da[name];
                    var sb = db[name];
                    return sa < sb ? -1 : sa > sb ? 1 : 0;
                }
            };
        }

        var file_filter = function (headerValue, rowValue, rowData, filterParams) {
            if (headerValue === "")
                return true;
            return rowData.file.toLowerCase().includes(headerValue.toLowerCase())
        }

        // TODO:
        // - tooltips for timing and lines of code
        // - tooltips for headers explaining shit
        // - more entries / libs
        // - two-level nodes for multi-version libs?
        // - compress data.js a bit (by not repeating everything)
        // - proper merge of multiple data files (add your own json!)
        // - specify test system
        // - filter by c++ version (and update ranges)
        // - links to projects in group header (poject_url)

        // tooltip content (exact numbers):
        // - on timing: compile, preproc, baselines
        // - on lines: with stripping, without
        // - on impact: how much of compile + binary

        // see http://tabulator.info/docs/4.6/quickstart
        var table = new Tabulator("#compile-table", {
            height: "1000",
            data: data,
            layout: "fitColumns",
            groupBy: "project",
            dataTree: true,
            responsiveLayout: "collapse",
            columns: [
                {
                    title: "Header / Source",
                    field: "name",
                    formatter: "html",
                    sorter: make_str_sorter("name"),
                    headerFilter: true,
                    headerFilterFunc: file_filter,
                    minWidth: 300,
                },
                {
                    title: "Version",
                    field: "version",
                    width: 100,
                    sorter: make_str_sorter("version"),
                },
                {
                    title: 'Impact <i class="fas fa-info-circle"></i>',
                    field: "impact",
                    width: 110,
                    formatter: "progress",
                    formatterParams: {
                        min: 0,
                        max: 100,
                        color: ["green", "orange", "red"],
                        legend: "",
                    },
                    sorter: make_sorter("impact"),
                },
                {
                    title: 'Timing <i class="fas fa-info-circle"></i>',
                    field: "ctime",
                    width: 140,
                    titleFormatter: "html",
                    formatter: "html",
                    hozAlign: "right",
                    titleFormatter: headerAlignRight,
                    sorter: make_sorter("ctime_max"),
                },
                {
                    title: 'Lines <i class="fas fa-info-circle"></i>',
                    field: "lines",
                    width: 160,
                    formatter: "html",
                    hozAlign: "right",
                    titleFormatter: headerAlignRight,
                    sorter: make_sorter("lines_max"),
                },
                {
                    title: 'Binary <i class="fas fa-info-circle"></i>',
                    field: "binsize",
                    width: 120,
                    formatter: "html",
                    hozAlign: "right",
                    titleFormatter: headerAlignRight,
                    sorter: make_sorter("binsize_max"),
                },
            ],
            groupStartOpen: function (value, count, data, group) {
                return value == "C++ Standard Library";
            },
            rowClick: function (e, row) {
                row.treeToggle();
            },
            groupToggleElement: "header",
        });

        function adaptSize() {
            var wh = $(".site-wrapper").height();
            var y = $("#compile-table").offset().top
            table.setHeight(wh - y);
        }

        $(window).resize(adaptSize);
        adaptSize();
    });
</script>

<!-- /post -->

<!-- The #contentFor helper here will send everything inside it up to the matching #block helper found in default.hbs -->
{% include page-scripts.html %}